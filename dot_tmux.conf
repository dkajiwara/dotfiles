# ============================================================
# Basic Settings
# ============================================================
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«
set-option -g default-shell /bin/zsh

# 256 è‰²è¡¨ç¤º
set-option -g default-terminal screen-256color
set -g terminal-overrides 'xterm:colors=256'

# ESC ã‚­ãƒ¼ã®é…å»¶ã‚’è§£æ¶ˆï¼ˆVim ä½¿ç”¨æ™‚ã«é‡è¦ï¼‰
set -s escape-time 0

# ============================================================
# Key Bindings
# ============================================================
# prefix ã‚­ãƒ¼ã‚’ C-a ã«å¤‰æ›´
set -g prefix C-a
unbind C-b

# è¨­å®šãƒªãƒ­ãƒ¼ãƒ‰
bind-key r source-file ~/.tmux.conf \; display-message "~/.tmux.conf reloaded"

# Vim ãƒ©ã‚¤ã‚¯ãªãƒšã‚¤ãƒ³é¸æŠ
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ»ãƒšã‚¤ãƒ³ä½œæˆæ™‚ã«ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¿æŒ
bind c new-window -c "#{pane_current_path}"
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# ============================================================
# Popup Windows
# ============================================================
# prefix + g: lazygit ã‚’ popup ã§é–‹ãï¼ˆ80% ã®å¹…ã¨é«˜ã•ï¼‰
bind g display-popup -d '#{pane_current_path}' -w80% -h80% -E lazygit

# prefix + f: fzf ã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã—ã¦é–‹ã
bind f display-popup -d '#{pane_current_path}' -w80% -h80% -E 'fd --type f --hidden --exclude .git | fzf --height=100% --prompt "Select file: " --preview "bat --color=always --style=numbers --line-range=:500 {}" --bind "enter:execute($EDITOR {})+abort"'

# prefix + t: ä¸€æ™‚çš„ãªã‚·ã‚§ãƒ«ã‚’ popup ã§é–‹ãï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–ï¼‰
bind t display-popup -d '#{pane_current_path}' -w80% -h80% -E 'TMUX= tmux new-session -A -s popup'

# prefix + D: popup ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
bind D kill-session -t popup

# prefix + s: fzf ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠã—ã¦ popup ã§è¡¨ç¤º
bind s display-popup -w80% -h80% -E 'session=$(tmux list-sessions -F "#{session_name}: #{session_windows} windows" | fzf --height=100% --reverse --prompt "Select tmux session: " --preview "tmux list-windows -t {1}" | cut -d: -f1) && [ -n "$session" ] && TMUX= tmux attach-session -t "$session"'

# prefix + p: ghq ã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã—ã¦ cd
bind p display-popup -w80% -h80% -E 'repo=$(ghq list | fzf --height=100% --prompt "Select repository: " --preview "ls -la $(ghq root)/{}" --preview-window=right:60%) && [ -n "$repo" ] && tmux send-keys -t $TMUX_PANE "cd $(ghq root)/$repo" Enter'

# prefix + m: man ãƒšãƒ¼ã‚¸ã‚’ popup ã§è¡¨ç¤º
bind m command-prompt -p "man:" "display-popup -w80% -h80% -E 'man %%'"

# ============================================================
# Status Bar
# ============================================================
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã‚’ä¸Šéƒ¨ã«é…ç½®
set-option -g status-position top

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã®é•·ã•
set-option -g status-left-length 90
set-option -g status-right-length 90

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼æ›´æ–°é–“éš”ï¼ˆç§’ï¼‰
set-option -g status-interval 1

# ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚¹ãƒˆã‚’å·¦æƒãˆ
set-option -g status-justify left

# ============================================================
# Mouse
# ============================================================
set-option -g mouse on
bind-key -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind-key -n WheelDownPane select-pane -t= \; send-keys -M

# ============================================================
# Copy Mode (Vi style)
# ============================================================
set-window-option -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection

# ============================================================
# Plugins
# ============================================================
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Kanagawa ãƒ†ãƒ¼ãƒ
set -g @plugin 'Nybkox/tmux-kanagawa'

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®èƒŒæ™¯è‰²ã‚’ä¿æŒ
set -g @kanagawa-ignore-window-colors true

# Powerline ã‚·ãƒ³ãƒœãƒ«ã‚’æœ‰åŠ¹åŒ–ï¼ˆã‚¿ãƒ–ã®è§’ã‚’ä¸‰è§’å½¢ã«ï¼‰
set -g @kanagawa-show-powerline true

# ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šï¼ˆCPU ä½¿ç”¨ç‡ã€RAM ä½¿ç”¨ç‡ã€SSH ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€æ™‚é–“ã‚’è¡¨ç¤ºï¼‰
set -g @kanagawa-plugins "cpu-usage ram-usage ssh-session time"

# ç©ºã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’éè¡¨ç¤º
set -g @kanagawa-show-empty-plugins true

# 24 æ™‚é–“è¡¨è¨˜
set -g @kanagawa-military-time true

# tmux ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«è‡ªå‹•ã§å¾©å…ƒ
set -g @continuum-restore 'on'

# ============================================================
# TPM (Tmux Plugin Manager)
# ============================================================
# TPM è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# TPM åˆæœŸåŒ–ï¼ˆã“ã®è¡Œã¯å¸¸ã«æœ€å¾Œã«é…ç½®ï¼‰
run '~/.tmux/plugins/tpm/tpm'

# ============================================================
# Theme Overrides
# ============================================================
# ãƒšã‚¤ãƒ³ãƒœãƒ¼ãƒ€ãƒ¼ã®è‰²è¨­å®šï¼ˆTPM åˆæœŸåŒ–å¾Œã«è¨˜è¿°ã—ã¦ãƒ†ãƒ¼ãƒã®è¨­å®šã‚’ä¸Šæ›¸ãï¼‰
set-option -g pane-border-style "fg=#54546D"
set-option -g pane-active-border-style "fg=#a3d4d5"

# ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã®è¡¨ç¤ºï¼ˆã‚ºãƒ¼ãƒ ä¸­ã¯è™«çœ¼é¡ã‚¢ã‚¤ã‚³ãƒ³ã‚’ status-left ã«è¡¨ç¤ºï¼‰
set-option -ag status-left "#{?window_zoomed_flag,#[fg=#ff9e3b] ğŸ”,}"
